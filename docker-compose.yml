################################################################################
# ğŸ“¦ Docker Compose for CircleCI Self-Hosted Runner
#
# ğŸ“ Má»¥c Ä‘Ã­ch:
#   Cháº¡y self-hosted CircleCI runner trong container báº±ng image tá»« GHCR.
#
# ğŸ§ª CÃ´ng nghá»‡ sá»­ dá»¥ng:
#   - Docker Compose
#   - Image: ghcr.io/nqdev-storage/circleci-docker-runner:latest
#   - CircleCI Self-Hosted Runner
#
# ğŸ‘¤ TÃ¡c giáº£: nqdev
# ğŸ“… NgÃ y táº¡o: 2025-06-10
#
# ğŸ“ YÃªu cáº§u:
#   - Docker + Docker Compose Ä‘Ã£ Ä‘Æ°á»£c cÃ i trÃªn host
#   - File `.env` chá»©a RUNNER_TOKEN tá»« CircleCI
#
# ğŸš€ Khá»Ÿi cháº¡y:
#   docker compose up -d
#
# ğŸ›‘ Dá»«ng container:
#   docker compose down
#
# ğŸ“„ Tham kháº£o thÃªm:
#   https://circleci.com/docs/self-hosted-runner
#   https://github.com/nqdev-storage/circleci-docker-runner
################################################################################

services:
  circleci-runner:
    image: ghcr.io/nqdev-storage/circleci-docker-runner:latest
    container_name: circleci-runner
    restart: unless-stopped
    # network_mode: host
    # ports:
    #   - "9000:9000"   # Web UI
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - RUNNER_TOKEN=${RUNNER_TOKEN}
    env_file:
      - .env
    volumes:
      - runner-data:/circleci
    extra_hosts:
      - "host.docker.internal:host-gateway" # Äá»ƒ káº¿t ná»‘i Ä‘áº¿n localhost cá»§a host tá»« container
    deploy:
      resources:
        limits:
          cpus: "0.80" # Giá»›i háº¡n 80% CPU
          memory: "3.2G" # Giá»›i háº¡n 3.2GB RAM (80% cá»§a 4GB)
        reservations:
          memory: "256M" # Äáº£m báº£o container cÃ³ Ã­t nháº¥t 256MB RAM

volumes:
  runner-data:
